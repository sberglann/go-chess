<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Chess</title>
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="js/chessboard-1.0.0.min.js"></script>
</head>
<body style="background-color: floralwhite">
<div id="board" style="width: 400px;margin:0px auto"></div>
<script>
    var legalMoves = [
        "rnbqkbnr/pppppppp/8/8/8/P7/1PPPPPPP/RNBQKBNR"
    ]

    var socket = new WebSocket("ws://localhost:8080/chess");


    const boardConfig = {
        draggable: true,
        dropOffBoard: 'snapback',
        onDrop: onDrop
    }

    var board = Chessboard('board', boardConfig);

    socket.onopen = function () {
        board.start(false);
    };

    socket.onmessage = function (e) {
        const message = JSON.parse(e.data);
        const currentPosition = message.move;
        legalMoves = message.legalMoves;
        board.position(currentPosition, false);
    };

    function onDrop(source, target, piece, newPos, oldPos, orientation) {
        const newPosFen = Chessboard.objToFen(newPos)
        if (legalMoves.includes(newPosFen)) {
            console.log('New position: ' + Chessboard.objToFen(newPos))
            var prevTurn = piece[0]
            var nextTurn = prevTurn == "w" ? "b" : "w"

            socket.send(newPosFen.concat(" ", nextTurn));
        } else {
            return 'snapback'
        }
    }
</script>
</body>
</html>